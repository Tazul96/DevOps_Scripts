#!/bin/bash

# Update and upgrade the Linux instance
sudo apt-get update -y
sudo apt-get upgrade -y

# Install Docker
sudo apt install -y apt-transport-https curl
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
sudo apt update -y
sudo apt install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
sudo systemctl is-active docker
sudo usermod -aG docker ${USER}

# Install inginx and update files
sudo apt-get install -y nginx
sudo bash -c 'cat > /etc/nginx/conf.d/test.ambel.conf <<EOF
upstream backend {
        server localhost:8000;
        # Add more backend servers as needed
    }

    server {
        server_name test.ambel.ca www.test.ambel.ca;  # Change this to your actual domain or IP address

        #root /var/www/html;

        # Add index.php to the list if you are using PHP
        #index index.html index.htm index.nginx-debian.html;

        location / {
            proxy_pass http://localhost:3000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /api {
            proxy_pass http://backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /socket.io {
            proxy_pass http://backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # WebSocket support
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_cache_bypass $http_upgrade;
        }
		
		location /userdata-extractor {
            proxy_pass http://backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /api/messageID-extractor {
            proxy_pass http://backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

        }
                # Additional settings for static files, caching, etc.
        # ...

        error_page 500 502 503 504 /50x.html;
        location = /50x.html {
            root /usr/share/nginx/html;
        }
}
EOF'
sudo bash -c 'cat > /etc/nginx/conf.d/message.test.ambel.ca.conf <<EOF
 server {
        server_name message.test.ambel.ca www.message.test.ambel.ca;  # Change this to your actual domain or IP address

        #root /var/www/html;

        # Add index.php to the list if you are using PHP
        #index index.html index.htm index.nginx-debian.html;

        location / {
            proxy_pass http://localhost:3001;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /messages/api {
            proxy_pass http://localhost:8001;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /socket.io {
            proxy_pass http://localhost:8001;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;


            # WebSocket support
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_cache_bypass $http_upgrade;
        }
                # Additional settings for static files, caching, etc.
        # ...

        error_page 500 502 503 504 /50x.html;
        location = /50x.html {
            root /usr/share/nginx/html;
        }
	}
EOF'

sudo systemctl restart nginx

#pull and run docker images

docker login -u tazul96 -p Ta@91912113 && docker pull tazul96/ambel:F-latest
docker run -d -p 3000:3000 --name frontend_app --restart always tazul96/ambel:F-latest

docker login -u tazul96 -p Ta@91912113 && docker pull tazul96/ambel:B-latest
docker run -d --name backend_app --restart always -p 8000:8000 tazul96/ambel:B-latest

docker login -u tazul96 -p Ta@91912113 && docker pull tazul96/ambel:MF-latest
docker run -d -p 3001:3001 --name message_frontend tazul96/ambel:MF-latest

docker login -u tazul96 -p Ta@91912113 && docker pull tazul96/ambel:MB-latest
docker run -d -p 8001:8001 --name message-backend tazul96/ambel:MB-latest


#Install and set github action
mkdir m-backend && cd m-backend
curl -o actions-runner-linux-x64-2.319.1.tar.gz -L https://github.com/actions/runner/releases/download/v2.319.1/actions-runner-linux-x64-2.319.1.tar.gz
echo "3f6efb7488a183e291fc2c62876e14c9ee732864173734facc85a1bfb1744464  actions-runner-linux-x64-2.319.1.tar.gz" | shasum -a 256 -c
tar xzf ./actions-runner-linux-x64-2.319.1.tar.gz
yes "" | ./config.sh --url https://github.com/Abexita/Ambel-Message-Backend --token AIE66OWWJ6TSVZUE4LNDT5DG44Y3G
sudo ./svc.sh install
sudo ./svc.sh start
cd

mkdir frontend; cd frontend
Invoke-WebRequest -Uri https://github.com/actions/runner/releases/download/v2.319.1/actions-runner-win-x64-2.319.1.zip -OutFile actions-runner-win-x64-2.319.1.zip
if((Get-FileHash -Path actions-runner-win-x64-2.319.1.zip -Algorithm SHA256).Hash.ToUpper() -ne '1c78c51d20b817fb639e0b0ab564cf0469d083ad543ca3d0d7a2cdad5723f3a7'.ToUpper()){ throw 'Computed checksum did not match' }
Add-Type -AssemblyName System.IO.Compression.FileSystem ; [System.IO.Compression.ZipFile]::ExtractToDirectory("$PWD/actions-runner-win-x64-2.319.1.zip", "$PWD")
yes "" | ./config.cmd --url https://github.com/Abexita/Ambel-Frontend-Main --token AIE66OQOMX7ORUYZWFD4MJTG44ZDY
sudo ./svc.sh install
sudo ./svc.sh start
cd


mkdir backend; cd backend
Invoke-WebRequest -Uri https://github.com/actions/runner/releases/download/v2.319.1/actions-runner-win-x64-2.319.1.zip -OutFile actions-runner-win-x64-2.319.1.zip
if((Get-FileHash -Path actions-runner-win-x64-2.319.1.zip -Algorithm SHA256).Hash.ToUpper() -ne '1c78c51d20b817fb639e0b0ab564cf0469d083ad543ca3d0d7a2cdad5723f3a7'.ToUpper()){ throw 'Computed checksum did not match' }
Add-Type -AssemblyName System.IO.Compression.FileSystem ; [System.IO.Compression.ZipFile]::ExtractToDirectory("$PWD/actions-runner-win-x64-2.319.1.zip", "$PWD")
yes "" | ./config.cmd --url https://github.com/Abexita/Ambel-Backend-Main --token AIE66OQ3K7PFVMDV723NETDG44ZNG
sudo ./svc.sh install
sudo ./svc.sh start
cd


mkdir m-frontend && cd m-frontend
curl -o actions-runner-linux-x64-2.319.1.tar.gz -L https://github.com/actions/runner/releases/download/v2.319.1/actions-runner-linux-x64-2.319.1.tar.gz
echo "3f6efb7488a183e291fc2c62876e14c9ee732864173734facc85a1bfb1744464  actions-runner-linux-x64-2.319.1.tar.gz" | shasum -a 256 -c
tar xzf ./actions-runner-linux-x64-2.319.1.tar.gz
yes "" | ./config.sh --url https://github.com/Abexita/Ambel-Message-Frontend --token AIE66OVNU463KQ4KP5MSXHLG44ZT6
sudo ./svc.sh install
sudo ./svc.sh start
cd